"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var pathToRegexp$1=_interopDefault(require("path-to-regexp"));function isChildRoute(e,t){if(null===e)return!1;let r=t;for(;r;)if((r=r.parent)===e)return!0;return!1}const{hasOwnProperty:hasOwnProperty}=Object.prototype,cache=new Map;function decodeParam(e){try{return decodeURIComponent(e)}catch(t){return e}}function matchPath(e,t,r,n){const o=!e.children,a=`${e.path||""}|${o}`;let s=cache.get(a);if(!s){const t=[];s={keys:t,pattern:pathToRegexp$1(e.path||"",t,{end:o})},cache.set(a,s)}const l=s.pattern.exec(t);if(!l)return null;const u=l[0],c={...n};for(let e=1;e<l.length;e++){const t=s.keys[e-1],r=t.name,n=l[e];void 0===n&&hasOwnProperty.call(c,r)||(t.repeat?c[r]=n?n.split(t.delimiter).map(decodeParam):[]:c[r]=n?decodeParam(n):n)}return{path:o||"/"!==u.charAt(u.length-1)?u:u.substr(1),keys:r.concat(s.keys),params:c}}function matchRoute(e,t,r,n,o){let a,s=null,l=0;return{next(u){if(e===u)return{done:!0,value:void 0};if(!s&&(s=matchPath(e,r,n,o)))return{done:!1,value:{route:e,baseUrl:t,path:s.path,keys:s.keys,params:s.params}};if(s&&e.children)for(;l<e.children.length;){if(!a){const n=e.children[l];n.parent=e,a=matchRoute(n,t+s.path,r.substr(s.path.length),s.keys,s.params)}const n=a.next(u);if(!n.done)return{done:!1,value:n.value};a=null,l++}return{done:!0,value:void 0}}}}function resolveRoute(e,t){if("function"==typeof e.route.action)return e.route.action(e,t)}class UniversalRouter{constructor(e,t={context:{}}){if(!e||"object"!=typeof e)throw new TypeError("Invalid routes");this.baseUrl=t.baseUrl||"",this.errorHandler=t.errorHandler,this.resolveRoute=t.resolveRoute||resolveRoute,this.context={router:this,...t.context},this.root=Array.isArray(e)?{path:"",children:e,parent:null}:e,this.root.parent=null}resolve(e){const t={...this.context,..."string"==typeof e?{pathname:e}:e},r=matchRoute(this.root,this.baseUrl,t.pathname.substr(this.baseUrl.length),[],null),n=this.resolveRoute;let o=null,a=null,s=t;function l(e,u=(o&&o.value?o.value.route:null),c){const i=o&&o.value?o.value.route:null,h=null===c?i:null;if(o=a||r.next(h),a=null,!e&&(o.done||!isChildRoute(u,o.value.route)))return a=o,Promise.resolve(null);if(o.done){const e=new Error("Route not found");return e.status=404,Promise.reject(e)}const p={...t,...o.value};return s=p,Promise.resolve(n(p,o.value.params)).then(t=>null!=t?t:l(e,u,t))}return t.next=l,Promise.resolve().then(()=>l(!0,this.root)).catch(e=>{if(this.errorHandler)return this.errorHandler(e,s);throw e})}}UniversalRouter.pathToRegexp=pathToRegexp$1;const{pathToRegexp:pathToRegexp}=UniversalRouter,cache$1=new Map;function cacheRoutes(e,t,r){if(e.has(t.name))throw new Error(`Route "${t.name}" already exists`);if(t.name&&e.set(t.name,t),r)for(let n=0;n<r.length;n++){const o=r[n];o.parent=t,cacheRoutes(e,o,o.children)}}function generateUrls(e,t={}){if(!(e instanceof UniversalRouter)){const t=e;if("object"!=typeof t||!t||!t.root)throw new TypeError("An instance of UniversalRouter is expected")}return e.routesByName=e.routesByName||new Map,(r,n)=>{const o=e.routesByName;let a=o.get(r);if(!(a||(o.clear(),cacheRoutes(o,e.root,e.root.children),a=o.get(r))))throw new Error(`Route "${r}" not found`);let s=cache$1.get(a.fullPath);if(!s){let e="",t=a;for(;t;){const r=Array.isArray(t.path)?t.path[0]:t.path;r&&(e=r+e),t=t.parent}const r=pathToRegexp.parse(e),n=pathToRegexp.tokensToFunction(r),o=Object.create(null);for(let e=0;e<r.length;e++){const t=r[e];"string"!=typeof t&&(o[t.name]=!0)}s={toPath:n,keys:o},cache$1.set(e,s),a.fullPath=e}let l=e.baseUrl+s.toPath(n,t)||"/";if(t.stringifyQueryParams&&n){const e={},r=Object.keys(n);for(let t=0;t<r.length;t++){const o=r[t];s.keys[o]||(e[o]=n[o])}const o=t.stringifyQueryParams(e);o&&(l+="?"===o.charAt(0)?o:`?${o}`)}return l}}exports.UniversalRouter=UniversalRouter,exports.generateUrls=generateUrls;
//# sourceMappingURL=universal-router-generate-urls.min.js.map
